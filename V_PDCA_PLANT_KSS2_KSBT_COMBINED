create or replace view DEV_EDW_PRESENTATION.HYBRID_COSTING.V_PDCA_PLANT_KSS2_KSBT_COMBINED(
	COST_CENTER_GROUP,
	COST_CENTER,
	ACTTYP,
	YEAR_MONTH,
	REPORTING_DATE,
	TOTAL_ACTUALCOST,
	TOTAL_QUANTITY,
	TOTAL_PRICE
) as
WITH COSS_UNPIVOTED AS (
    SELECT 
        FISCAL_YEAR,
        OBJECT_NUMBER,
        COST_ELEMENT,
        VALUE_TYPE,
        DEBITCREDIT_INDICATOR,
        WTGColumn,
        WTGValue,
        SUBSTR(WTGColumn, 37) AS Period
    FROM 
         DEV_EDW_INTG.SAPSS2_INT.FACT_COSS_CO_OBJECT_COST_TOTALS_FOR_INTERNAL_POSTINGS
    UNPIVOT (
        WTGValue FOR WTGColumn IN (
            TOTAL_VALUE_IN_TRANSACTION_CURRENCY_1, TOTAL_VALUE_IN_TRANSACTION_CURRENCY_2, TOTAL_VALUE_IN_TRANSACTION_CURRENCY_3, TOTAL_VALUE_IN_TRANSACTION_CURRENCY_4, 
            TOTAL_VALUE_IN_TRANSACTION_CURRENCY_5, TOTAL_VALUE_IN_TRANSACTION_CURRENCY_6, TOTAL_VALUE_IN_TRANSACTION_CURRENCY_7, TOTAL_VALUE_IN_TRANSACTION_CURRENCY_8,           
            TOTAL_VALUE_IN_TRANSACTION_CURRENCY_9, TOTAL_VALUE_IN_TRANSACTION_CURRENCY_10, TOTAL_VALUE_IN_TRANSACTION_CURRENCY_11, TOTAL_VALUE_IN_TRANSACTION_CURRENCY_12, 
            TOTAL_VALUE_IN_TRANSACTION_CURRENCY_13, TOTAL_VALUE_IN_TRANSACTION_CURRENCY_14, TOTAL_VALUE_IN_TRANSACTION_CURRENCY_15, TOTAL_VALUE_IN_TRANSACTION_CURRENCY_16
        )
    )
    WHERE VALUE_TYPE = '03'   --02 Target Cost and 03 is Actual Cost
    AND VERSION = '000'
),
COSL_UNPIVOTED AS (
    SELECT 
        OBJECT_NUMBER,
        FISCAL_YEAR,
        VALUE_TYPE,
        ACTIVITY_UNIT,
        SUBSTR(LSTColumn, 19) AS Period,
        LSTColumn,
        LSTValue
    FROM 
        DEV_EDW_INTG.SAPSS2_INT.FACT_COSL_CO_OBJECT_ACTIVITY_TYPE_TOTALS
    UNPIVOT (
        LSTValue FOR LSTColumn IN (
            ACTIVITY_QUANTITY_1, ACTIVITY_QUANTITY_2, ACTIVITY_QUANTITY_3, ACTIVITY_QUANTITY_4, 
            ACTIVITY_QUANTITY_5, ACTIVITY_QUANTITY_6, ACTIVITY_QUANTITY_7, ACTIVITY_QUANTITY_8,
            ACTIVITY_QUANTITY_9, ACTIVITY_QUANTITY_10, ACTIVITY_QUANTITY_11, ACTIVITY_QUANTITY_12, 
            ACTIVITY_QUANTITY_13, ACTIVITY_QUANTITY_14, ACTIVITY_QUANTITY_15,ACTIVITY_QUANTITY_16
        )
    )
    WHERE VALUE_TYPE = '04'   --04 Actual Qty
     AND VERSION = '000'
),
KSS2_VIEW AS (
    SELECT DISTINCT
        CSKS.PLANT AS Plant, 
        LTRIM(CSKS.COST_CENTER, '0') AS COST_CENTER, 
        CSKT.GENERAL_NAME AS Description,
        CSKS.OBJECT_NUMBER,
        CSSL.ACTIVITY_TYPE AS ActTyp,
        CSSL.OBJECT_NUMBER AS CSSLOBJNR,
        COSS.COST_ELEMENT,
        COSS.VALUE_TYPE,
        COSS.DEBITCREDIT_INDICATOR,
        COSS.FISCAL_YEAR AS YEAR,
        COSS.Period AS CostPeriod,
        COSS.WTGColumn,
        COSS.WTGValue AS TOTALCOST,
        COSL.LSTColumn,
        COSL.Period AS QuantityPeriod,
        COSL.LSTValue AS TotalQuantity,
        CASE 
            WHEN COSS.VALUE_TYPE = '02' THEN COSS.WTGValue
            ELSE 0 
        END AS TargetCost,
        CASE 
            WHEN COSS.VALUE_TYPE = '03' THEN COSS.WTGValue
            ELSE 0 
        END AS ActualCost,
        CASE 
            WHEN CAST(COSS.PERIOD AS INTEGER) BETWEEN 1 AND 16 THEN 
                COSS.FISCAL_YEAR || '-' || LPAD(CAST(COSS.PERIOD AS STRING), 2, '0')
            ELSE 
                NULL 
        END AS YEAR_MONTH
    FROM 
        DEV_EDW_INTG.SAPSS2_INT.DIM_CSKS_COST_CENTER_MASTER AS CSKS 
        LEFT JOIN DEV_EDW_INTG.SAPSS2_INT.DIM_CSSL_COST_CENTER_ACTIVITY_TYPE AS CSSL ON CSKS.COST_CENTER = CSSL.COST_CENTER
        LEFT JOIN DEV_EDW_INTG.SAPSS2_INT.DIM_CSKT_COST_CENTER_TEXT AS CSKT ON CSKS.CLIENT = CSKT.CLIENT 
            AND CSKS.COST_CENTER = CSKT.COST_CENTER 
            AND CSKS.CONTROLLING_AREA = CSKT.CONTROLLING_AREA
            AND CSKT.LANGUAGE_KEY = 'E'
        LEFT JOIN COSS_UNPIVOTED COSS ON CSKS.CLIENT = CSSL.CLIENT 
            AND CSSL.OBJECT_NUMBER = COSS.OBJECT_NUMBER
        LEFT JOIN COSL_UNPIVOTED COSL ON CSKS.CLIENT = CSSL.CLIENT 
            AND CSSL.OBJECT_NUMBER = COSL.OBJECT_NUMBER
            AND COSS.Period = COSL.Period
            AND COSS.FISCAL_YEAR = COSL.FISCAL_YEAR
    WHERE 
        CSKS.CLIENT = '300' 
        AND TO_DATE(CSKT.VALID_TO_DATE, 'YYYYMMDD') > CURRENT_DATE()
        AND COSS.VALUE_TYPE = '03'
),
KSBT_VIEW AS (
    WITH COST_UNPIVOTED AS (
        SELECT DISTINCT
            OBJECT_NUMBER,
            FISCAL_YEAR,
            VALUE_TYPE,
            PRICE_INDICATOR_CALCULATE_ALLOCATION_PRICE,
            SUBSTR(TOTAL_PRICEColumn, 53) AS Period,
            TOTAL_PRICEColumn,
            TOTAL_PRICEValue
        FROM 
            DEV_EDW_INTG.SAPSS2_INT.FACT_COST_CO_OBJECT_PRICE_TOTALS
        UNPIVOT (
            TOTAL_PRICEValue FOR TOTAL_PRICEColumn IN (
                TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_1, TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_2, TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_3, 
                TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_4, TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_5, TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_6, 
                TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_7, TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_8,
                TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_9, TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_10, TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_11, 
                TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_12, TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_13, TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_14, 
                TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_15, TOTAL_PRICE_PER_UNIT_OF_MEASURE_IN_CO_AREA_CURRENCY_16
            )
        )
        WHERE VALUE_TYPE = '04'   -- Actual Quantity
          AND PRICE_INDICATOR_CALCULATE_ALLOCATION_PRICE = '005'
          AND VERSION = '000'
    )
    SELECT DISTINCT
        CSKS.PLANT AS PLANT, 
        LTRIM(CSSL.COST_CENTER, '0') AS COST_CENTER, 
        CSKT.GENERAL_NAME AS DESCRIPTION,
        CSKS.OBJECT_NUMBER,
        CSSL.ACTIVITY_TYPE AS ACTTYP,
        CSSL.OBJECT_NUMBER AS COSTOBJNR,
        COST.FISCAL_YEAR AS YEAR,
        COST.PERIOD AS COSTPERIOD,
        B.COST_CENTER_GROUP,
        COST.TOTAL_PRICEValue AS TOTAL_PRICE,
        CASE 
            WHEN CAST(COST.PERIOD AS INTEGER) BETWEEN 1 AND 16 THEN 
                COST.FISCAL_YEAR || '-' || LPAD(CAST(COST.PERIOD AS STRING), 2, '0')
            ELSE 
                NULL 
        END AS YEAR_MONTH
    FROM 
        DEV_EDW_INTG.SAPSS2_INT.DIM_CSKS_COST_CENTER_MASTER AS CSKS 
        LEFT JOIN DEV_EDW_INTG.SAPSS2_INT.DIM_CSSL_COST_CENTER_ACTIVITY_TYPE AS CSSL 
            ON CSKS.COST_CENTER = CSSL.COST_CENTER
        LEFT JOIN DEV_EDW_INTG.SAPSS2_INT.DIM_CSKT_COST_CENTER_TEXT AS CSKT 
            ON CSKS.CLIENT = CSKT.CLIENT 
            AND CSKS.COST_CENTER = CSKT.COST_CENTER 
            AND CSKS.CONTROLLING_AREA = CSKT.CONTROLLING_AREA
            AND CSKT.LANGUAGE_KEY = 'E'
        LEFT JOIN COST_UNPIVOTED AS COST 
            ON CSKS.CLIENT = CSSL.CLIENT 
            AND CSSL.OBJECT_NUMBER = COST.OBJECT_NUMBER
        LEFT JOIN DEV_EDW_INTG.SAPSS4_INT.V_HOMO_NONHOMO_COST_CENTERS B
             ON LTRIM(CSKS.COST_CENTER, '0') = B.COST_CENTER
    WHERE 
        CSKS.CLIENT = '300' 
        AND TO_DATE(CSKT.VALID_TO_DATE, 'YYYYMMDD') > CURRENT_DATE()
)
SELECT 
    C.COST_CENTER_GROUP, 
    A.COST_CENTER, 
    A.ACTTYP, 
    A.YEAR_MONTH, 
    a.YEAR_MONTH AS Reporting_Date,
    SUM(A.ACTUALCOST) AS TOTAL_ACTUALCOST, 
    AVG(A.TOTALQUANTITY) AS TOTAL_QUANTITY, 
    AVG(B.TOTAL_PRICE) AS TOTAL_PRICE
FROM 
    KSS2_VIEW A
LEFT JOIN 
    KSBT_VIEW B
ON  
    A.COST_CENTER = B.COST_CENTER
    AND A.ACTTYP = B.ACTTYP
    AND A.YEAR_MONTH = B.YEAR_MONTH
LEFT JOIN DEV_EDW_INTG.SAPSS4_INT.V_HOMO_NONHOMO_COST_CENTERS C
         ON A.COST_CENTER = C.COST_CENTER
GROUP BY 
    C.COST_CENTER_GROUP, 
    A.COST_CENTER, 
    A.ACTTYP, 
    A.YEAR_MONTH
HAVING 
    SUM(TOTAL_PRICE) > 0;
